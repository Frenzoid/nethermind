// SPDX-FileCopyrightText: 2022 Demerzel Solutions Limited
// SPDX-License-Identifier: LGPL-3.0-only

#if DEBUG
using Nethermind.Evm.Tracing.DebugTrace;
using Nethermind.Evm.Tracing.GethStyle;
using System.Threading.Tasks;
using System;
using Nethermind.Int256;
using Nethermind.Specs.Forks;
using NUnit.Framework;
using System.Text.Json;
using System.Threading;
using Nethermind.Core.Extensions;
using Nethermind.Core;
using Nethermind.Core.Test.Builders;

namespace Nethermind.Evm.Test
{
    public class DebugTracerTests : VirtualMachineTestsBase
    {
        public GethLikeTxTracer GethLikeTxTracer => new GethLikeTxTracer(GethTraceOptions.Default);

        [SetUp]
        public override void Setup()
        {
            base.Setup();
        }

        [TestCase("0x608060405234801561001057600080fd5b5061690880620000216000396000f3fe6080604052600436106100f35760003560e01c806368dbc76f1161008a578063b411165411610059578063b4111654146103c7578063d1cff35b14610406578063e1b55fb414610443578063fa935cfe1461045f576100f3565b806368dbc76f146102c857806376a7a6891461030a5780638f6c7a3c1461034b578063960d244e1461038a576100f3565b80634aa3ab93116100c65780634aa3ab93146101e15780634c7389091461021e578063510feb4e146102495780636282786114610288576100f3565b806306b68323146100f857806308f6b6a81461013557806317a047c314610172578063407a4b08146101a2575b600080fd5b34801561010457600080fd5b5061011f600480360381019061011a91906153ec565b6104a0565b60405161012c919061606d565b60405180910390f35b34801561014157600080fd5b5061015c600480360381019061015791906153ec565b6105e8565b6040516101699190615d6d565b60405180910390f35b61018c6004803603810190610187919061542d565b610855565b604051610199919061604b565b60405180910390f35b3480156101ae57600080fd5b506101c960048036038101906101c49190615205565b610da6565b6040516101d893929190615f89565b60405180910390f35b3480156101ed57600080fd5b5061020860048036038101906102039190615162565b61115d565b604051610215919061606d565b60405180910390f35b34801561022a57600080fd5b5061023361130b565b60405161024091906160cf565b60405180910390f35b34801561025557600080fd5b50610270600480360381019061026b91906153ec565b611313565b60405161027f93929190615d8f565b60405180910390f35b34801561029457600080fd5b506102af60048036038101906102aa91906151b6565b611828565b6040516102bf9493929190615ddb565b60405180910390f35b3480156102d457600080fd5b506102ef60048036038101906102ea9190615348565b611dfa565b60405161030196959493929190615eb2565b60405180910390f35b34801561031657600080fd5b50610331600480360381019061032c9190615205565b612886565b604051610342959493929190615fd5565b60405180910390f35b34801561035757600080fd5b50610372600480360381019061036d91906151b6565b612f82565b60405161038193929190615d8f565b60405180910390f35b34801561039657600080fd5b506103b160048036038101906103ac91906150ff565b61340a565b6040516103be91906160cf565b60405180910390f35b3480156103d357600080fd5b506103ee60048036038101906103e991906153ec565b6135d2565b6040516103fd93929190615f3d565b60405180910390f35b34801561041257600080fd5b5061042d6004803603810190610428919061524a565b6139f8565b60405161043a9190615d6d565b60405180910390f35b61045d600480360381019061045891906154c0565b613e93565b005b34801561046b57600080fd5b50610486600480360381019061048191906152d3565b613f8e565b604051610497959493929190615e3c565b60405180910390f35b60606000825167ffffffffffffffff8111156104e5577f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b6040519080825280602002602001820160405280156105135781602001602082028036833780820191505090505b50905060005b83518161ffff1610156105de57838161ffff1681518110610563577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b602002602001015173ffffffffffffffffffffffffffffffffffffffff1631828261ffff16815181106105bf577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b60200260200101818152505080806105d69061662f565b915050610519565b5080915050919050565b6060815167ffffffffffffffff81111561062b577f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b6040519080825280602002602001820160405280156106595781602001602082028036833780820191505090505b50905060005b825181101561084f5760008382815181106106a3577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b602002602001015190508073ffffffffffffffffffffffffffffffffffffffff1663c45a01556040518163ffffffff1660e01b815260040160206040518083038186803b1580156106f357600080fd5b505afa92505050801561072457506040513d601f19601f8201168201806040525081019061072191906150d6565b60015b6107c55761073061677b565b8061073b57506107b6565b6000848481518110610776577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b602002602001019073ffffffffffffffffffffffffffffffffffffffff16908173ffffffffffffffffffffffffffffffffffffffff1681525050506107c0565b3d6000803e3d6000fd5b61083b565b808484815181106107ff577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b602002602001019073ffffffffffffffffffffffffffffffffffffffff16908173ffffffffffffffffffffffffffffffffffffffff1681525050505b5080806108479061665a565b91505061065f565b50919050565b60606000835167ffffffffffffffff81111561089a577f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b6040519080825280602002602001820160405280156108c85781602001602082028036833780820191505090505b5090506000479050600034905060006108e1838361487d565b905060008751826108f2919061646a565b905060008761ffff161415610963578873ffffffffffffffffffffffffffffffffffffffff1663d0e30db0836040518263ffffffff1660e01b81526004016000604051808303818588803b15801561094957600080fd5b505af115801561095d573d6000803e3d6000fd5b50505050505b60005b8851811015610d955760008b82815181106109aa577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b602002602001015190506000839050600080610a07848f8f88815181106109fa577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b6020026020010151614896565b90506000811415610a1c57619c409150610d2e565b85811015610a28578092505b6000600267ffffffffffffffff811115610a6b577f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b604051908082528060200260200182016040528015610a995781602001602082028036833780820191505090505b5090508e81600081518110610ad7577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b602002602001019073ffffffffffffffffffffffffffffffffffffffff16908173ffffffffffffffffffffffffffffffffffffffff16815250508d8681518110610b4a577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b602002602001015181600181518110610b8c577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b602002602001019073ffffffffffffffffffffffffffffffffffffffff16908173ffffffffffffffffffffffffffffffffffffffff16815250508e73ffffffffffffffffffffffffffffffffffffffff1663095ea7b386866040518363ffffffff1660e01b8152600401610c01929190615d44565b602060405180830381600087803b158015610c1b57600080fd5b505af1158015610c2f573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190610c539190615594565b506000610c798683600a600189610c6a919061649b565b610c74919061646a565b614a3c565b9050614e208161ffff161415610c9357614e209350610d2b565b6000610cb88784600a60098a610ca9919061649b565b610cb3919061646a565b614a3c565b90508061ffff168261ffff16118015610ce0575060018183610cda91906164f5565b61ffff16115b80610d0d57508061ffff168261ffff16108015610d0c575060018282610d0691906164f5565b61ffff16115b5b15610d1c576175309450610d29565b610d268183614d0e565b94505b505b50505b818a8681518110610d68577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b602002602001019061ffff16908161ffff1681525050505050508080610d8d9061665a565b915050610966565b508495505050505050949350505050565b606080606060008585905067ffffffffffffffff811115610df0577f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b604051908082528060200260200182016040528015610e1e5781602001602082028036833780820191505090505b50905060008686905067ffffffffffffffff811115610e66577f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b604051908082528060200260200182016040528015610e945781602001602082028036833780820191505090505b50905060008787905067ffffffffffffffff811115610edc577f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b604051908082528060200260200182016040528015610f0a5781602001602082028036833780820191505090505b50905060005b888890508163ffffffff1610156111495760008060008b8b8563ffffffff16818110610f65577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b9050602002016020810190610f7a91906150ad565b73ffffffffffffffffffffffffffffffffffffffff16630902f1ac6040518163ffffffff1660e01b815260040160606040518083038186803b158015610fbf57600080fd5b505afa158015610fd3573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190610ff791906155fe565b92509250925082878563ffffffff168151811061103d577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b60200260200101906dffffffffffffffffffffffffffff1690816dffffffffffffffffffffffffffff168152505081868563ffffffff16815181106110ab577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b60200260200101906dffffffffffffffffffffffffffff1690816dffffffffffffffffffffffffffff168152505080858563ffffffff1681518110611119577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b602002602001019063ffffffff16908163ffffffff16815250505050508080611141906166a3565b915050610f10565b508282829550955095505050509250925092565b6060815167ffffffffffffffff8111156111a0577f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b6040519080825280602002602001820160405280156111ce5781602001602082028036833780820191505090505b509050600083905060005b8351811015611303578173ffffffffffffffffffffffffffffffffffffffff166370a08231858381518110611237577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b60200260200101516040518263ffffffff1660e01b815260040161125b9190615d00565b60206040518083038186803b15801561127357600080fd5b505afa158015611287573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906112ab919061564d565b8382815181106112e4577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b60200260200101818152505080806112fb9061665a565b9150506111d9565b505092915050565b600047905090565b6060806060835167ffffffffffffffff811115611359577f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b6040519080825280602002602001820160405280156113875781602001602082028036833780820191505090505b509250835167ffffffffffffffff8111156113cb577f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b6040519080825280602002602001820160405280156113f95781602001602082028036833780820191505090505b509150835167ffffffffffffffff81111561143d577f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b60405190808252806020026020018201604052801561146b5781602001602082028036833780820191505090505b50905060005b8451811015611820578481815181106114b3577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b602002602001015173ffffffffffffffffffffffffffffffffffffffff1663c45a01556040518163ffffffff1660e01b815260040160206040518083038186803b15801561150057600080fd5b505afa158015611514573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061153891906150d6565b848281518110611571577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b602002602001019073ffffffffffffffffffffffffffffffffffffffff16908173ffffffffffffffffffffffffffffffffffffffff16815250508481815181106115e4577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b602002602001015173ffffffffffffffffffffffffffffffffffffffff16630dfe16816040518163ffffffff1660e01b815260040160206040518083038186803b15801561163157600080fd5b505afa158015611645573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061166991906150d6565b8382815181106116a2577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b602002602001019073ffffffffffffffffffffffffffffffffffffffff16908173ffffffffffffffffffffffffffffffffffffffff1681525050848181518110611715577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b602002602001015173ffffffffffffffffffffffffffffffffffffffff1663d21220a76040518163ffffffff1660e01b815260040160206040518083038186803b15801561176257600080fd5b505afa158015611776573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061179a91906150d6565b8282815181106117d3577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b602002602001019073ffffffffffffffffffffffffffffffffffffffff16908173ffffffffffffffffffffffffffffffffffffffff168152505080806118189061665a565b915050611471565b509193909250565b6060806060806000868661183c9190616529565b90508067ffffffffffffffff81111561187e577f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b6040519080825280602002602001820160405280156118ac5781602001602082028036833780820191505090505b5094508067ffffffffffffffff8111156118ef577f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b60405190808252806020026020018201604052801561191d5781602001602082028036833780820191505090505b5093508067ffffffffffffffff811115611960577f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b60405190808252806020026020018201604052801561198e5781602001602082028036833780820191505090505b5092508067ffffffffffffffff8111156119d1577f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b6040519080825280602002602001820160405280156119ff5781602001602082028036833780820191505090505b5091506000808890505b87811015611dee5760008a73ffffffffffffffffffffffffffffffffffffffff16631e3dd18b836040518263ffffffff1660e01b8152600401611a4c91906160cf565b60206040518083038186803b158015611a6457600080fd5b505afa158015611a78573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190611a9c91906150d6565b905080888481518110611ad8577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b602002602001019073ffffffffffffffffffffffffffffffffffffffff16908173ffffffffffffffffffffffffffffffffffffffff16815250508073ffffffffffffffffffffffffffffffffffffffff16630dfe16816040518163ffffffff1660e01b815260040160206040518083038186803b158015611b5857600080fd5b505afa158015611b6c573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190611b9091906150d6565b878481518110611bc9577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b602002602001019073ffffffffffffffffffffffffffffffffffffffff16908173ffffffffffffffffffffffffffffffffffffffff16815250508073ffffffffffffffffffffffffffffffffffffffff1663d21220a76040518163ffffffff1660e01b815260040160206040518083038186803b158015611c4957600080fd5b505afa158015611c5d573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190611c8191906150d6565b868481518110611cba577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b602002602001019073ffffffffffffffffffffffffffffffffffffffff16908173ffffffffffffffffffffffffffffffffffffffff16815250506000808273ffffffffffffffffffffffffffffffffffffffff166332bfe4696040518163ffffffff1660e01b8152600401604080518083038186803b158015611d3c57600080fd5b505afa158015611d50573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190611d74919061569f565b63ffffffff16915091508163ffffffff16878681518110611dbe577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b6020026020010181815250508480611dd59061665a565b9550505050508080611de69061665a565b915050611a09565b50505093509350935093565b6060806060806060808b8b905067ffffffffffffffff811115611e46577f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b604051908082528060200260200182016040528015611e7957816020015b6060815260200190600190039081611e645790505b5095508b8b905067ffffffffffffffff811115611ebf577f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b604051908082528060200260200182016040528015611eed5781602001602082028036833780820191505090505b5093508b8b905067ffffffffffffffff811115611f33577f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b604051908082528060200260200182016040528015611f6657816020015b6060815260200190600190039081611f515790505b5094508b8b905067ffffffffffffffff811115611fac577f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b604051908082528060200260200182016040528015611fda5781602001602082028036833780820191505090505b5092508b8b905067ffffffffffffffff811115612020577f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b60405190808252806020026020018201604052801561204e5781602001602082028036833780820191505090505b5091508b8b905067ffffffffffffffff811115612094577f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b6040519080825280602002602001820160405280156120c25781602001602082028036833780820191505090505b509050600080600080600090505b8f8f90508163ffffffff161015612873578d8d8263ffffffff16818110612120577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b9050602002013591508f8f8263ffffffff16818110612168577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b905060200201602081019061217d91906150ad565b92508b8b8263ffffffff168181106121be577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b90506020020160208101906121d391906150ad565b935060008267ffffffffffffffff811115612217577f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b6040519080825280602002602001820160405280156122455781602001602082028036833780820191505090505b50905060008367ffffffffffffffff81111561228a577f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b6040519080825280602002602001820160405280156122b85781602001602082028036833780820191505090505b50905060005b848110156124a3578573ffffffffffffffffffffffffffffffffffffffff1663c6610657826040518263ffffffff1660e01b81526004016122ff91906160cf565b60206040518083038186803b15801561231757600080fd5b505afa15801561232b573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061234f91906150d6565b838281518110612388577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b602002602001019073ffffffffffffffffffffffffffffffffffffffff16908173ffffffffffffffffffffffffffffffffffffffff16815250508573ffffffffffffffffffffffffffffffffffffffff16634903b0d1826040518263ffffffff1660e01b81526004016123fb91906160cf565b60206040518083038186803b15801561241357600080fd5b505afa158015612427573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061244b919061564d565b828281518110612484577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b602002602001018181525050808061249b9061665a565b9150506122be565b50818c8463ffffffff16815181106124e4577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b60200260200101819052508473ffffffffffffffffffffffffffffffffffffffff1663f446c1d06040518163ffffffff1660e01b815260040160206040518083038186803b15801561253557600080fd5b505afa158015612549573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061256d919061564d565b8a8463ffffffff16815181106125ac577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b602002602001018181525050808b8463ffffffff16815181106125f8577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b60200260200101819052508473ffffffffffffffffffffffffffffffffffffffff1663ddca3f436040518163ffffffff1660e01b815260040160206040518083038186803b15801561264957600080fd5b505afa15801561265d573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190612681919061564d565b898463ffffffff16815181106126c0577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b6020026020010181815250508473ffffffffffffffffffffffffffffffffffffffff1663bb7b8b806040518163ffffffff1660e01b815260040160206040518083038186803b15801561271257600080fd5b505afa158015612726573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061274a919061564d565b888463ffffffff1681518110612789577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b6020026020010181815250508573ffffffffffffffffffffffffffffffffffffffff166318160ddd6040518163ffffffff1660e01b815260040160206040518083038186803b1580156127db57600080fd5b505afa1580156127ef573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190612813919061564d565b878463ffffffff1681518110612852577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b6020026020010181815250505050808061286b906166a3565b9150506120d0565b5050505096509650965096509650969050565b60608060608060608686905067ffffffffffffffff8111156128d1577f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b6040519080825280602002602001820160405280156128ff5781602001602082028036833780820191505090505b5094508686905067ffffffffffffffff811115612945577f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b6040519080825280602002602001820160405280156129735781602001602082028036833780820191505090505b5093508686905067ffffffffffffffff8111156129b9577f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b6040519080825280602002602001820160405280156129e75781602001602082028036833780820191505090505b5092508686905067ffffffffffffffff811115612a2d577f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b604051908082528060200260200182016040528015612a5b5781602001602082028036833780820191505090505b5091508686905067ffffffffffffffff811115612aa1577f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b604051908082528060200260200182016040528015612acf5781602001602082028036833780820191505090505b50905060008060008060008060005b8d8d90508163ffffffff161015612f71578d8d8263ffffffff16818110612b2e577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b9050602002016020810190612b4391906150ad565b73ffffffffffffffffffffffffffffffffffffffff16630902f1ac6040518163ffffffff1660e01b815260040160606040518083038186803b158015612b8857600080fd5b505afa158015612b9c573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190612bc091906155fe565b8095508196508297505050508d8d8263ffffffff16818110612c0b577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b9050602002016020810190612c2091906150ad565b73ffffffffffffffffffffffffffffffffffffffff166332bfe4696040518163ffffffff1660e01b8152600401604080518083038186803b158015612c6457600080fd5b505afa158015612c78573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190612c9c919061569f565b50809750508d8d8263ffffffff16818110612ce0577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b9050602002016020810190612cf591906150ad565b73ffffffffffffffffffffffffffffffffffffffff1663d4cadf686040518163ffffffff1660e01b815260040160206040518083038186803b158015612d3a57600080fd5b505afa158015612d4e573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190612d729190615676565b9150848c8263ffffffff1681518110612db4577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b60200260200101906dffffffffffffffffffffffffffff1690816dffffffffffffffffffffffffffff1681525050838b8263ffffffff1681518110612e22577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b60200260200101906dffffffffffffffffffffffffffff1690816dffffffffffffffffffffffffffff1681525050828a8263ffffffff1681518110612e90577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b602002602001019063ffffffff16908163ffffffff168152505086898263ffffffff1681518110612eea577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b602002602001019063ffffffff16908163ffffffff168152505081888263ffffffff1681518110612f44577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b602002602001019063ffffffff16908163ffffffff16815250508080612f69906166a3565b915050612ade565b505050505050509295509295909350565b606080606060008585612f959190616529565b90508067ffffffffffffffff811115612fd7577f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b6040519080825280602002602001820160405280156130055781602001602082028036833780820191505090505b5093508067ffffffffffffffff811115613048577f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b6040519080825280602002602001820160405280156130765781602001602082028036833780820191505090505b5092508067ffffffffffffffff8111156130b9577f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b6040519080825280602002602001820160405280156130e75781602001602082028036833780820191505090505b5091506000808790505b868110156133fe5760008973ffffffffffffffffffffffffffffffffffffffff16631e3dd18b836040518263ffffffff1660e01b815260040161313491906160cf565b60206040518083038186803b15801561314c57600080fd5b505afa158015613160573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061318491906150d6565b9050808784815181106131c0577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b602002602001019073ffffffffffffffffffffffffffffffffffffffff16908173ffffffffffffffffffffffffffffffffffffffff16815250508073ffffffffffffffffffffffffffffffffffffffff16630dfe16816040518163ffffffff1660e01b815260040160206040518083038186803b15801561324057600080fd5b505afa158015613254573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061327891906150d6565b8684815181106132b1577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b602002602001019073ffffffffffffffffffffffffffffffffffffffff16908173ffffffffffffffffffffffffffffffffffffffff16815250508073ffffffffffffffffffffffffffffffffffffffff1663d21220a76040518163ffffffff1660e01b815260040160206040518083038186803b15801561333157600080fd5b505afa158015613345573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061336991906150d6565b8584815181106133a2577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b602002602001019073ffffffffffffffffffffffffffffffffffffffff16908173ffffffffffffffffffffffffffffffffffffffff168152505082806133e79061665a565b9350505080806133f69061665a565b9150506130f1565b50505093509350939050565b600080859050828173ffffffffffffffffffffffffffffffffffffffff166370a08231876040518263ffffffff1660e01b815260040161344a9190615d00565b60206040518083038186803b15801561346257600080fd5b505afa158015613476573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061349a919061564d565b101580156135325750828173ffffffffffffffffffffffffffffffffffffffff1663dd62ed3e87876040518363ffffffff1660e01b81526004016134df929190615d1b565b60206040518083038186803b1580156134f757600080fd5b505afa15801561350b573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061352f919061564d565b10155b61353d5760006135c7565b8073ffffffffffffffffffffffffffffffffffffffff166370a08231866040518263ffffffff1660e01b81526004016135769190615d00565b60206040518083038186803b15801561358e57600080fd5b505afa1580156135a2573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906135c6919061564d565b5b915050949350505050565b6060806060835167ffffffffffffffff811115613618577f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b60405190808252806020026020018201604052801561364b57816020015b60608152602001906001900390816136365790505b509250835167ffffffffffffffff81111561368f577f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b6040519080825280602002602001820160405280156136c257816020015b60608152602001906001900390816136ad5790505b509150835167ffffffffffffffff811115613706577f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b6040519080825280602002602001820160405280156137345781602001602082028036833780820191505090505b50905060005b84518110156139f057600085828151811061377e577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b602002602001015190508073ffffffffffffffffffffffffffffffffffffffff166306fdde036040518163ffffffff1660e01b815260040160006040518083038186803b1580156137ce57600080fd5b505afa1580156137e2573d6000803e3d6000fd5b505050506040513d6000823e3d601f19601f8201168201806040525081019061380b91906155bd565b858381518110613844577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b60200260200101819052508073ffffffffffffffffffffffffffffffffffffffff1663313ce5676040518163ffffffff1660e01b815260040160206040518083038186803b15801561389557600080fd5b505afa1580156138a9573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906138cd91906156db565b60ff16838381518110613909577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b6020026020010181815250508073ffffffffffffffffffffffffffffffffffffffff166395d89b416040518163ffffffff1660e01b815260040160006040518083038186803b15801561395b57600080fd5b505afa15801561396f573d6000803e3d6000fd5b505050506040513d6000823e3d601f19601f8201168201806040525081019061399891906155bd565b8483815181106139d1577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b60200260200101819052505080806139e89061665a565b91505061373a565b509193909250565b60606000849050600073ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff161415613a6f576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401613a66906160af565b60405180910390fd5b60008484905088889050613a83919061649b565b67ffffffffffffffff811115613ac2577f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b604051908082528060200260200182016040528015613af05781602001602082028036833780820191505090505b5090506000805b898990508163ffffffff161015613e835760005b87879050811015613e6f576000888883818110613b51577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b9050602002016020810190613b6691906150ad565b9050600073ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff161415613bd8576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401613bcf9061608f565b60405180910390fd5b60008c8c8563ffffffff16818110613c19577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b9050602002016020810190613c2e91906150ad565b73ffffffffffffffffffffffffffffffffffffffff1663e6a4390588846040518363ffffffff1660e01b8152600401613c68929190615d1b565b60206040518083038186803b158015613c8057600080fd5b505afa158015613c94573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190613cb891906150d6565b9050600073ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff161415613dd2578c8c8563ffffffff16818110613d2e577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b9050602002016020810190613d4391906150ad565b73ffffffffffffffffffffffffffffffffffffffff1663c9c6539688846040518363ffffffff1660e01b8152600401613d7d929190615d1b565b602060405180830381600087803b158015613d9757600080fd5b505af1158015613dab573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190613dcf91906150d6565b90505b80868663ffffffff1681518110613e12577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b602002602001019073ffffffffffffffffffffffffffffffffffffffff16908173ffffffffffffffffffffffffffffffffffffffff16815250508480613e57906166a3565b95505050508080613e679061665a565b915050613b0b565b508080613e7b906166a3565b915050613af7565b5081935050505095945050505050565b8251845114613ea157600080fd5b60005b8451811015613f8757848181518110613ee6577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b602002602001015173ffffffffffffffffffffffffffffffffffffffff166108fc858381518110613f40577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b60200260200101519081150290604051600060405180830381858888f19350505050158015613f73573d6000803e3d6000fd5b508080613f7f9061665a565b915050613ea4565b5050505050565b60608060608060608888905067ffffffffffffffff811115613fd9577f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b60405190808252806020026020018201604052801561400c57816020015b6060815260200190600190039081613ff75790505b5094508888905067ffffffffffffffff811115614052577f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b6040519080825280602002602001820160405280156140805781602001602082028036833780820191505090505b5092508888905067ffffffffffffffff8111156140c6577f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b6040519080825280602002602001820160405280156140f957816020015b60608152602001906001900390816140e45790505b5093508888905067ffffffffffffffff81111561413f577f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b60405190808252806020026020018201604052801561416d5781602001602082028036833780820191505090505b5091508888905067ffffffffffffffff8111156141b3577f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b6040519080825280602002602001820160405280156141e15781602001602082028036833780820191505090505b50905060005b898990508163ffffffff16101561487157600088888363ffffffff16818110614239577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b90506020020135905060008b8b8463ffffffff16818110614283577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b905060200201602081019061429891906150ad565b905060008267ffffffffffffffff8111156142dc577f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b60405190808252806020026020018201604052801561430a5781602001602082028036833780820191505090505b50905060008367ffffffffffffffff81111561434f577f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b60405190808252806020026020018201604052801561437d5781602001602082028036833780820191505090505b50905060005b84811015614568578373ffffffffffffffffffffffffffffffffffffffff1663c6610657826040518263ffffffff1660e01b81526004016143c491906160cf565b60206040518083038186803b1580156143dc57600080fd5b505afa1580156143f0573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061441491906150d6565b83828151811061444d577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b602002602001019073ffffffffffffffffffffffffffffffffffffffff16908173ffffffffffffffffffffffffffffffffffffffff16815250508373ffffffffffffffffffffffffffffffffffffffff16634903b0d1826040518263ffffffff1660e01b81526004016144c091906160cf565b60206040518083038186803b1580156144d857600080fd5b505afa1580156144ec573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190614510919061564d565b828281518110614549577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b60200260200101818152505080806145609061665a565b915050614383565b50818a8663ffffffff16815181106145a9577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b602002602001018190525080898663ffffffff16815181106145f4577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b60200260200101819052508273ffffffffffffffffffffffffffffffffffffffff1663f446c1d06040518163ffffffff1660e01b815260040160206040518083038186803b15801561464557600080fd5b505afa158015614659573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061467d919061564d565b888663ffffffff16815181106146bc577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b6020026020010181815250508273ffffffffffffffffffffffffffffffffffffffff1663ddca3f436040518163ffffffff1660e01b815260040160206040518083038186803b15801561470e57600080fd5b505afa158015614722573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190614746919061564d565b878663ffffffff1681518110614785577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b6020026020010181815250508273ffffffffffffffffffffffffffffffffffffffff1663bb7b8b806040518163ffffffff1660e01b815260040160206040518083038186803b1580156147d757600080fd5b505afa1580156147eb573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061480f919061564d565b868663ffffffff168151811061484e577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b602002602001018181525050505050508080614869906166a3565b9150506141e7565b50945094509450945094565b600081831161488c578161488e565b825b905092915050565b60008084905060008173ffffffffffffffffffffffffffffffffffffffff1663c45a01556040518163ffffffff1660e01b815260040160206040518083038186803b1580156148e457600080fd5b505afa1580156148f8573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061491c91906150d6565b90508473ffffffffffffffffffffffffffffffffffffffff166370a082318273ffffffffffffffffffffffffffffffffffffffff1663e6a4390588886040518363ffffffff1660e01b8152600401614975929190615d1b565b60206040518083038186803b15801561498d57600080fd5b505afa1580156149a1573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906149c591906150d6565b6040518263ffffffff1660e01b81526004016149e19190615d00565b60206040518083038186803b1580156149f957600080fd5b505afa158015614a0d573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190614a31919061564d565b925050509392505050565b60008084905060008173ffffffffffffffffffffffffffffffffffffffff166338ed17398560008830600142614a729190616414565b6040518663ffffffff1660e01b8152600401614a929594939291906160ea565b600060405180830381600087803b158015614aac57600080fd5b505af1925050508015614ae257506040513d6000823e3d601f19601f82011682018060405250810190614adf9190615553565b60015b614b23573d8060008114614b12576040519150601f19603f3d011682016040523d82523d6000602084013e614b17565b606091505b50614e20915050614d02565b60008160018351614b349190616529565b81518110614b6b577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b6020026020010151905060008760018951614b869190616529565b81518110614bbd577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b6020026020010151905060008173ffffffffffffffffffffffffffffffffffffffff166370a08231306040518263ffffffff1660e01b8152600401614c029190615d00565b60206040518083038186803b158015614c1a57600080fd5b505afa158015614c2e573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190614c52919061564d565b90508173ffffffffffffffffffffffffffffffffffffffff1663a9059cbb33836040518363ffffffff1660e01b8152600401614c8f929190615d44565b602060405180830381600087803b158015614ca957600080fd5b505af1158015614cbd573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190614ce19190615594565b508261271082614cf1919061649b565b614cfb919061646a565b9450505050505b80925050509392505050565b60008161ffff168361ffff161115614d2857819050614d2c565b8290505b92915050565b6000614d45614d4084616175565b616144565b90508083825260208201905082856020860282011115614d6457600080fd5b60005b85811015614d945781614d7a8882614eb4565b845260208401935060208301925050600181019050614d67565b5050509392505050565b6000614db1614dac846161a1565b616144565b90508083825260208201905082856020860282011115614dd057600080fd5b60005b85811015614e005781614de68882615059565b845260208401935060208301925050600181019050614dd3565b5050509392505050565b6000614e1d614e18846161a1565b616144565b90508083825260208201905082856020860282011115614e3c57600080fd5b60005b85811015614e6c5781614e52888261506e565b845260208401935060208301925050600181019050614e3f565b5050509392505050565b6000614e89614e84846161cd565b616144565b905082815260208101848484011115614ea157600080fd5b614eac8482856165fc565b509392505050565b600081359050614ec381616831565b92915050565b600081519050614ed881616831565b92915050565b60008083601f840112614ef057600080fd5b8235905067ffffffffffffffff811115614f0957600080fd5b602083019150836020820283011115614f2157600080fd5b9250929050565b600082601f830112614f3957600080fd5b8135614f49848260208601614d32565b91505092915050565b60008083601f840112614f6457600080fd5b8235905067ffffffffffffffff811115614f7d57600080fd5b602083019150836020820283011115614f9557600080fd5b9250929050565b600082601f830112614fad57600080fd5b8135614fbd848260208601614d9e565b91505092915050565b600082601f830112614fd757600080fd5b8151614fe7848260208601614e0a565b91505092915050565b600081519050614fff81616848565b92915050565b600082601f83011261501657600080fd5b8151615026848260208601614e76565b91505092915050565b60008151905061503e8161685f565b92915050565b60008135905061505381616876565b92915050565b6000813590506150688161688d565b92915050565b60008151905061507d8161688d565b92915050565b600081519050615092816168a4565b92915050565b6000815190506150a7816168bb565b92915050565b6000602082840312156150bf57600080fd5b60006150cd84828501614eb4565b91505092915050565b6000602082840312156150e857600080fd5b60006150f684828501614ec9565b91505092915050565b6000806000806080858703121561511557600080fd5b600061512387828801614eb4565b945050602061513487828801614eb4565b935050604061514587828801614eb4565b925050606061515687828801615059565b91505092959194509250565b6000806040838503121561517557600080fd5b600061518385828601614eb4565b925050602083013567ffffffffffffffff8111156151a057600080fd5b6151ac85828601614f28565b9150509250929050565b6000806000606084860312156151cb57600080fd5b60006151d986828701614eb4565b93505060206151ea86828701615059565b92505060406151fb86828701615059565b9150509250925092565b6000806020838503121561521857600080fd5b600083013567ffffffffffffffff81111561523257600080fd5b61523e85828601614ede565b92509250509250929050565b60008060008060006060868803121561526257600080fd5b600086013567ffffffffffffffff81111561527c57600080fd5b61528888828901614ede565b9550955050602061529b88828901614eb4565b935050604086013567ffffffffffffffff8111156152b857600080fd5b6152c488828901614ede565b92509250509295509295909350565b600080600080604085870312156152e957600080fd5b600085013567ffffffffffffffff81111561530357600080fd5b61530f87828801614ede565b9450945050602085013567ffffffffffffffff81111561532e57600080fd5b61533a87828801614f52565b925092505092959194509250565b6000806000806000806060878903121561536157600080fd5b600087013567ffffffffffffffff81111561537b57600080fd5b61538789828a01614ede565b9650965050602087013567ffffffffffffffff8111156153a657600080fd5b6153b289828a01614f52565b9450945050604087013567ffffffffffffffff8111156153d157600080fd5b6153dd89828a01614ede565b92509250509295509295509295565b6000602082840312156153fe57600080fd5b600082013567ffffffffffffffff81111561541857600080fd5b61542484828501614f28565b91505092915050565b6000806000806080858703121561544357600080fd5b600085013567ffffffffffffffff81111561545d57600080fd5b61546987828801614f28565b945050602061547a87828801614eb4565b935050604085013567ffffffffffffffff81111561549757600080fd5b6154a387828801614f28565b92505060606154b487828801615044565b91505092959194509250565b600080600080608085870312156154d657600080fd5b600085013567ffffffffffffffff8111156154f057600080fd5b6154fc87828801614f28565b945050602085013567ffffffffffffffff81111561551957600080fd5b61552587828801614f9c565b935050604061553687828801614eb4565b925050606061554787828801615059565b91505092959194509250565b60006020828403121561556557600080fd5b600082015167ffffffffffffffff81111561557f57600080fd5b61558b84828501614fc6565b91505092915050565b6000602082840312156155a657600080fd5b60006155b484828501614ff0565b91505092915050565b6000602082840312156155cf57600080fd5b600082015167ffffffffffffffff8111156155e957600080fd5b6155f584828501615005565b91505092915050565b60008060006060848603121561561357600080fd5b60006156218682870161502f565b93505060206156328682870161502f565b925050604061564386828701615083565b9150509250925092565b60006020828403121561565f57600080fd5b600061566d8482850161506e565b91505092915050565b60006020828403121561568857600080fd5b600061569684828501615083565b91505092915050565b600080604083850312156156b257600080fd5b60006156c085828601615083565b92505060206156d185828601615083565b9150509250929050565b6000602082840312156156ed57600080fd5b60006156fb84828501615098565b91505092915050565b600061571083836157b8565b60208301905092915050565b600061572883836157d6565b905092915050565b600061573c8383615aad565b905092915050565b60006157508383615bd6565b905092915050565b60006157648383615cb5565b60208301905092915050565b600061577c8383615cc4565b60208301905092915050565b60006157948383615cd3565b60208301905092915050565b60006157ac8383615cf1565b60208301905092915050565b6157c18161655d565b82525050565b6157d08161655d565b82525050565b60006157e18261627d565b6157eb8185616348565b93506157f6836161fd565b8060005b8381101561582757815161580e8882615704565b9750615819836162e0565b9250506001810190506157fa565b5085935050505092915050565b600061583f8261627d565b6158498185616359565b9350615854836161fd565b8060005b8381101561588557815161586c8882615704565b9750615877836162e0565b925050600181019050615858565b5085935050505092915050565b600061589d82616288565b6158a7818561636a565b9350836020820285016158b98561620d565b8060005b858110156158f557848403895281516158d6858261571c565b94506158e1836162ed565b925060208a019950506001810190506158bd565b50829750879550505050505092915050565b600061591282616293565b61591c818561637b565b93508360208202850161592e8561621d565b8060005b8581101561596a578484038952815161594b8582615730565b9450615956836162fa565b925060208a01995050600181019050615932565b50829750879550505050505092915050565b60006159878261629e565b615991818561638c565b9350836020820285016159a38561622d565b8060005b858110156159df57848403895281516159c08582615744565b94506159cb83616307565b925060208a019950506001810190506159a7565b50829750879550505050505092915050565b60006159fc826162a9565b615a06818561639d565b9350615a118361623d565b8060005b83811015615a42578151615a298882615758565b9750615a3483616314565b925050600181019050615a15565b5085935050505092915050565b6000615a5a826162b4565b615a6481856163ae565b9350615a6f8361624d565b8060005b83811015615aa0578151615a878882615770565b9750615a9283616321565b925050600181019050615a73565b5085935050505092915050565b6000615ab8826162bf565b615ac281856163bf565b9350615acd8361625d565b8060005b83811015615afe578151615ae58882615788565b9750615af08361632e565b925050600181019050615ad1565b5085935050505092915050565b6000615b16826162bf565b615b2081856163d0565b9350615b2b8361625d565b8060005b83811015615b5c578151615b438882615788565b9750615b4e8361632e565b925050600181019050615b2f565b5085935050505092915050565b6000615b74826162ca565b615b7e81856163e1565b9350615b898361626d565b8060005b83811015615bba578151615ba188826157a0565b9750615bac8361633b565b925050600181019050615b8d565b5085935050505092915050565b615bd0816165ea565b82525050565b6000615be1826162d5565b615beb81856163f2565b9350615bfb8185602086016165fc565b615c048161675d565b840191505092915050565b6000615c1c602183616403565b91507f536f6d65206f66207468652074617267657420617373657473206973206e756c60008301527f6c000000000000000000000000000000000000000000000000000000000000006020830152604082019050919050565b6000615c82601283616403565b91507f42617365206173736574206973206e756c6c00000000000000000000000000006000830152602082019050919050565b615cbe8161657b565b82525050565b615ccd81616595565b82525050565b615cdc816165c3565b82525050565b615ceb816165c3565b82525050565b615cfa816165cd565b82525050565b6000602082019050615d1560008301846157c7565b92915050565b6000604082019050615d3060008301856157c7565b615d3d60208301846157c7565b9392505050565b6000604082019050615d5960008301856157c7565b615d666020830184615ce2565b9392505050565b60006020820190508181036000830152615d878184615834565b905092915050565b60006060820190508181036000830152615da98186615834565b90508181036020830152615dbd8185615834565b90508181036040830152615dd18184615834565b9050949350505050565b60006080820190508181036000830152615df58187615834565b90508181036020830152615e098186615834565b90508181036040830152615e1d8185615834565b90508181036060830152615e318184615b0b565b905095945050505050565b600060a0820190508181036000830152615e568188615892565b90508181036020830152615e6a8187615907565b90508181036040830152615e7e8186615b0b565b90508181036060830152615e928185615b0b565b90508181036080830152615ea68184615b0b565b90509695505050505050565b600060c0820190508181036000830152615ecc8189615892565b90508181036020830152615ee08188615907565b90508181036040830152615ef48187615b0b565b90508181036060830152615f088186615b0b565b90508181036080830152615f1c8185615b0b565b905081810360a0830152615f308184615b0b565b9050979650505050505050565b60006060820190508181036000830152615f57818661597c565b90508181036020830152615f6b818561597c565b90508181036040830152615f7f8184615b0b565b9050949350505050565b60006060820190508181036000830152615fa381866159f1565b90508181036020830152615fb781856159f1565b90508181036040830152615fcb8184615b69565b9050949350505050565b600060a0820190508181036000830152615fef81886159f1565b9050818103602083015261600381876159f1565b905081810360408301526160178186615b69565b9050818103606083015261602b8185615b69565b9050818103608083015261603f8184615b69565b90509695505050505050565b600060208201905081810360008301526160658184615a4f565b905092915050565b600060208201905081810360008301526160878184615b0b565b905092915050565b600060208201905081810360008301526160a881615c0f565b9050919050565b600060208201905081810360008301526160c881615c75565b9050919050565b60006020820190506160e46000830184615ce2565b92915050565b600060a0820190506160ff6000830188615ce2565b61610c6020830187615bc7565b818103604083015261611e8186615834565b905061612d60608301856157c7565b61613a6080830184615ce2565b9695505050505050565b6000604051905081810181811067ffffffffffffffff8211171561616b5761616a61672e565b5b8060405250919050565b600067ffffffffffffffff8211156161905761618f61672e565b5b602082029050602081019050919050565b600067ffffffffffffffff8211156161bc576161bb61672e565b5b602082029050602081019050919050565b600067ffffffffffffffff8211156161e8576161e761672e565b5b601f19601f8301169050602081019050919050565b6000819050602082019050919050565b6000819050602082019050919050565b6000819050602082019050919050565b6000819050602082019050919050565b6000819050602082019050919050565b6000819050602082019050919050565b6000819050602082019050919050565b6000819050602082019050919050565b600081519050919050565b600081519050919050565b600081519050919050565b600081519050919050565b600081519050919050565b600081519050919050565b600081519050919050565b600081519050919050565b600081519050919050565b6000602082019050919050565b6000602082019050919050565b6000602082019050919050565b6000602082019050919050565b6000602082019050919050565b6000602082019050919050565b6000602082019050919050565b6000602082019050919050565b600082825260208201905092915050565b600082825260208201905092915050565b600082825260208201905092915050565b600082825260208201905092915050565b600082825260208201905092915050565b600082825260208201905092915050565b600082825260208201905092915050565b600082825260208201905092915050565b600082825260208201905092915050565b600082825260208201905092915050565b600082825260208201905092915050565b600082825260208201905092915050565b600061641f826165c3565b915061642a836165c3565b9250827fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff0382111561645f5761645e6166d0565b5b828201905092915050565b6000616475826165c3565b9150616480836165c3565b9250826164905761648f6166ff565b5b828204905092915050565b60006164a6826165c3565b91506164b1836165c3565b9250817fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff04831182151516156164ea576164e96166d0565b5b828202905092915050565b600061650082616595565b915061650b83616595565b92508282101561651e5761651d6166d0565b5b828203905092915050565b6000616534826165c3565b915061653f836165c3565b925082821015616552576165516166d0565b5b828203905092915050565b6000616568826165a3565b9050919050565b60008115159050919050565b60006dffffffffffffffffffffffffffff82169050919050565b600061ffff82169050919050565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b6000819050919050565b600063ffffffff82169050919050565b600060ff82169050919050565b60006165f5826165c3565b9050919050565b60005b8381101561661a5780820151818401526020810190506165ff565b83811115616629576000848401525b50505050565b600061663a82616595565b915061ffff82141561664f5761664e6166d0565b5b600182019050919050565b6000616665826165c3565b91507fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff821415616698576166976166d0565b5b600182019050919050565b60006166ae826165cd565b915063ffffffff8214156166c5576166c46166d0565b5b600182019050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601260045260246000fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b6000601f19601f8301169050919050565b60008160e01c9050919050565b600060443d101561678b5761682e565b60046000803e61679c60005161676e565b6308c379a081146167ad575061682e565b60405160043d036004823e80513d602482011167ffffffffffffffff821117156167d95750505061682e565b808201805167ffffffffffffffff8111156167f857505050505061682e565b8060208301013d85018111156168135750505050505061682e565b61681c8261675d565b60208401016040528296505050505050505b90565b61683a8161655d565b811461684557600080fd5b50565b6168518161656f565b811461685c57600080fd5b50565b6168688161657b565b811461687357600080fd5b50565b61687f81616595565b811461688a57600080fd5b50565b616896816165c3565b81146168a157600080fd5b50565b6168ad816165cd565b81146168b857600080fd5b50565b6168c4816165dd565b81146168cf57600080fd5b5056fea264697066735822122030b46c247d00c2469f8f3517d552edce97baacdfa39cdfc70d6895bd16fe8e6f64736f6c63430008000033")]
        public void Energy_Web_Debug_Evmcode(string bytecodeHex)
        {
            byte[] bytecode = Bytes.FromHexString(bytecodeHex);


            using DebugTracer tracer = new DebugTracer(GethLikeTxTracer)
            {
                IsStepByStepModeOn = true,
            };

            Thread vmThread = new Thread(() => Execute(tracer, bytecode));
            vmThread.Start();

            long? initialGas = null;
            // expected initial gas : 5565176
            // found initial gas : 5565173 + 3 cost of first opcode (PUSH1)

            long? gas = null;
            while (vmThread.IsAlive)
            {
                if (tracer.CanReadState)
                {
                    initialGas ??= tracer.CurrentState.GasAvailable;
                    gas = tracer.CurrentState.GasAvailable;
                    tracer.MoveNext();
                }

            }

            long? consumerGas = initialGas - gas;
            // expected consumed gas : 6,478
            // found consumed gas : 6,478
            var traces = JsonSerializer.Serialize((tracer.InnerTracer as GethLikeTxTracer).BuildResult());
            // Tx expected gas used : 5558698
            // Tx found gas used : 5558698

            // Question(Ayman) : what does the tx processor do with the returned bytecode from createTx, and what gas shennanigans does it calculate ?

        }

        [TestCase("0x5b601760005600")]
        public void Debugger_Halts_Execution_On_Breakpoint(string bytecodeHex)
        {
            // this bytecode create an infinite loop that keeps pushing 0x17 to the stack so it is bound to stackoverflow (or even to use up its gas) i.e :  
            byte[] bytecode = Bytes.FromHexString(bytecodeHex);

            (int depth, int pc) JUMP_OPCODE_PTR_BREAK_POINT = (0, 5);
            using DebugTracer tracer = new DebugTracer(GethLikeTxTracer)
            {
                // we activate GoToNextBreakpoint mode (i.e : deactivate StepByStepMode)
                IsStepByStepModeOn = false,
            };

            // we set the break point to BREAK_POINT
            tracer.SetBreakPoint(JUMP_OPCODE_PTR_BREAK_POINT);

            // we set the break point to BREAK_POINT
            Thread vmThread = new Thread(() => Execute(tracer, bytecode));
            vmThread.Start();

            // we run the bytecode for <confidenceLevelDesired> iteration and check how many times we stopped at BREAK_POINT
            int confidenceLevelDesired = 100;
            int confidenceLevelReached = 0;
            int iterationsCount = 0;

            // Test fails if iterationsCount != confidenceLevelReached != confidenceLevelDesired
            bool TestFailed = false;

            while (vmThread.IsAlive)
            {
                if (tracer.CanReadState)
                {
                    iterationsCount++;
                    confidenceLevelReached += tracer.CurrentState.ProgramCounter == JUMP_OPCODE_PTR_BREAK_POINT.pc ? 1 : 0;
                    if (iterationsCount == confidenceLevelDesired)
                    {
                        TestFailed = confidenceLevelReached < confidenceLevelDesired;
                        tracer.Abort();
                        vmThread.Interrupt();
                        break;
                    }

                    tracer.MoveNext();
                }

            }

            Assert.False(TestFailed);
        }

        [TestCase("0x5b601760005600")]
        public void Debugger_Halts_Execution_On_Breakpoint_If_Condition_Is_True(string bytecodeHex)
        {
            // this bytecode create an infinite loop that keeps pushing 0x17 to the stack so it is bound to stackoverflow (or even to use up its gas) i.e :  
            byte[] bytecode = Bytes.FromHexString(bytecodeHex);

            (int depth, int pc) JUMP_OPCODE_PTR_BREAK_POINT = (0, 5);
            using DebugTracer tracer = new DebugTracer(GethLikeTxTracer)
            {
                // we activate GoToNextBreakpoint mode (i.e : deactivate StepByStepMode)
                IsStepByStepModeOn = false,
            };

            // we set the break point to BREAK_POINT
            tracer.SetBreakPoint(JUMP_OPCODE_PTR_BREAK_POINT, state =>
            {
                return state.DataStackHead == 23;
            });

            Thread vmThread = new(() => Execute(tracer, bytecode));
            vmThread.Start();

            // we run the bytecode for <confidenceLevelDesired> iteration and check how many times we stopped at BREAK_POINT
            int confidenceLevelDesired = 100;
            int confidenceLevelReached = 0;
            int iterationsCount = 0;

            // Test fails if confidenceLevelReached > 1
            bool TestFailed = false;

            while (vmThread.IsAlive)
            {
                if (tracer.CanReadState)
                {
                    iterationsCount++;
                    confidenceLevelReached += tracer.CurrentState.ProgramCounter == JUMP_OPCODE_PTR_BREAK_POINT.pc ? 1 : 0;

                    if (iterationsCount == confidenceLevelDesired)
                    {
                        TestFailed = confidenceLevelReached > 1;

                        tracer.Abort();
                        vmThread.Interrupt();
                    }

                    tracer.MoveNext();
                }
            }

            Assert.False(TestFailed);
        }

        [TestCase("0x5b5b5b5b5b5b5b5b5b5b00")]
        public void Debugger_Halts_Execution_On_Eeach_Iteration_using_StepByStepMode(string bytecodeHex)
        {
            // this bytecode is just a bunch of NOP/JUMPDEST, the idea is it will take as much bytes in the bytecode as steps to go throught it
            byte[] bytecode = Bytes.FromHexString(bytecodeHex);

            using DebugTracer tracer = new DebugTracer(GethLikeTxTracer)
            {
                // we activate step by step mode in tracer
                IsStepByStepModeOn = true,
            };

            Thread vmThread = new Thread(() => Execute(tracer, bytecode));
            vmThread.Start();

            int countBreaks = 0;

            while (vmThread.IsAlive)
            {
                if (tracer.CanReadState)
                {
                    // we count how many steps it took to run the bytecode
                    countBreaks++;

                    tracer.MoveNext();
                }
            }

            countBreaks--; //Pre-run break

            // we check that it matches the number of opcodes in the bytecode
            Assert.That(bytecode.Length, Is.EqualTo(countBreaks));
        }

        [TestCase("0x5b5b5b5b5b5b5b5b5b5b00")]
        public void Debugger_Skips_Single_Step_Breakpoints_When_MoveNext_Uses_Override(string bytecodeHex)
        {
            // this bytecode is just a bunch of NOP/JUMPDEST, the idea is it will take as much bytes in the bytecode as steps to go throught it
            byte[] bytecode = Bytes.FromHexString(bytecodeHex);

            using DebugTracer tracer = new DebugTracer(GethLikeTxTracer)
            {
                // we activate step by step mode in tracer
                IsStepByStepModeOn = true,
            };

            Thread vmThread = new Thread(() => Execute(tracer, bytecode));
            vmThread.Start();

            int countBreaks = 0;

            while (vmThread.IsAlive)
            {
                if (tracer.CanReadState)
                {
                    // we count how many steps it took to run the bytecode
                    countBreaks++;

                    tracer.MoveNext(executeOneStep: false);
                }
            }

            // we check that it matches the number of opcodes in the bytecode
            Assert.That(countBreaks, Is.EqualTo(1));
        }

        [TestCase("0x5b5b5b5b5b5b5b5b5b5b00")]
        public void Debugger_Switches_To_Single_Steps_After_First_Breakpoint(string bytecodeHex)
        {
            // this bytecode is just a bunch of NOP/JUMPDEST, the idea is it will take as much bytes in the bytecode as steps to go throught it
            byte[] bytecode = Bytes.FromHexString(bytecodeHex);

            (int depth, int pc) BREAKPOINT = (0, 5);
            using DebugTracer tracer = new DebugTracer(GethLikeTxTracer)
            {
                // we activate step by step mode in tracer
                IsStepByStepModeOn = false,
            };

            tracer.SetBreakPoint(BREAKPOINT);

            Thread vmThread = new Thread(() => Execute(tracer, bytecode));
            vmThread.Start();

            int countBreaks = -1; // not counting the post-run stop

            while (vmThread.IsAlive)
            {
                if (tracer.CanReadState)
                {
                    // we count how many steps it took to run the bytecode
                    countBreaks++;

                    tracer.MoveNext(executeOneStep: true);
                }
            }

            // we check that it matches the number of opcodes in the bytecode
            Assert.That(countBreaks, Is.EqualTo(bytecode.Length - BREAKPOINT.pc));
        }

        [TestCase("0x5b601760005600")]
        public void Debugger_Can_Alter_Program_Counter(string bytecodeHex)
        {
            // this bytecode create an infinite loop that keeps pushing 0x17 to the stack so it is bound to stackoverflow (or even to use up its gas) i.e :  
            byte[] bytecode = Bytes.FromHexString(bytecodeHex);

            (int depth, int pc) JUMP_OPCODE_PTR_BREAK_POINT = (0, 5);
            using DebugTracer tracer = new DebugTracer(GethLikeTxTracer)
            {
                IsStepByStepModeOn = true,
            };

            tracer.SetBreakPoint(JUMP_OPCODE_PTR_BREAK_POINT);

            Thread vmThread = new Thread(() => Execute(tracer, bytecode));
            vmThread.Start();

            while (vmThread.IsAlive)
            {
                if (tracer.CanReadState)
                {
                    tracer.CurrentState.ProgramCounter++;
                    tracer.MoveNext();
                }
            }

            // we check if bytecode execution failed
            var resultTraces = (tracer.InnerTracer as GethLikeTxTracer).BuildResult();
            Assert.IsFalse(resultTraces.Failed);
        }

        [TestCase("5b6017600160005700")]
        public void Debugger_Can_Alter_Data_Stack(string bytecodeHex)
        {
            // this bytecode create an infinite loop that keeps pushing 0x17 to the stack so it is bound to stackoverflow (or even to use up its gas) i.e :  
            byte[] bytecode = Bytes.FromHexString(bytecodeHex);

            (int depth, int pc) JUMP_OPCODE_PTR_BREAK_POINT = (0, 5);
            using DebugTracer tracer = new DebugTracer(GethLikeTxTracer)
            {
                IsStepByStepModeOn = false,
            };

            tracer.SetBreakPoint(JUMP_OPCODE_PTR_BREAK_POINT);

            Thread vmThread = new Thread(() => Execute(tracer, bytecode));
            vmThread.Start();

            while (vmThread.IsAlive)
            {
                if (tracer.CanReadState)
                {
                    // we pop the condition and overwrite it with a false to force breaking out of the loop
                    EvmStack stack = new(tracer.CurrentState.DataStack, tracer.CurrentState.DataStackHead, tracer);
                    stack.PopLimbo();
                    stack.PushByte(0x00);

                    tracer.MoveNext();
                }
            }

            // we check if bytecode execution failed
            var resultTraces = (tracer.InnerTracer as GethLikeTxTracer).BuildResult();
            Assert.IsFalse(resultTraces.Failed);
        }

        [TestCase("6017806000526000511460005260206000f3")]
        public void Debugger_Can_Alter_Memory(string bytecodeHex)
        {
            // this bytecode create an infinite loop that keeps pushing 0x17 to the stack so it is bound to stackoverflow (or even to use up its gas) i.e :  
            byte[] bytecode = Bytes.FromHexString(bytecodeHex);

            (int depth, int pc) MSTORE_OPCODE_PTR_BREAK_POINT = (0, 6);
            using DebugTracer tracer = new DebugTracer(GethLikeTxTracer)
            {
                IsStepByStepModeOn = false,
            };

            tracer.SetBreakPoint(MSTORE_OPCODE_PTR_BREAK_POINT);

            Thread vmThread = new Thread(() => Execute(tracer, bytecode));
            vmThread.Start();

            while (vmThread.IsAlive)
            {
                if (tracer.CanReadState)
                {
                    // we alter the value stored in memory to force EQ check at the end to fail
                    tracer.CurrentState.Memory.SaveByte(31, 0x0A);

                    tracer.MoveNext();
                }
            }

            // we check if bytecode execution failed
            var resultTraces = (tracer.InnerTracer as GethLikeTxTracer).BuildResult();
            Assert.IsTrue(resultTraces.ReturnValue[31] == 0);
        }

        [TestCase("6017806000526000511460005260206000f3")]
        public void Use_Debug_Tracer_To_Check_Assertion_Live(string bytecodeHex)
        {
            // this bytecode create an infinite loop that keeps pushing 0x17 to the stack so it is bound to stackoverflow (or even to use up its gas) i.e :  
            byte[] bytecode = Bytes.FromHexString(bytecodeHex);

            (int depth, int pc) MSTORE_OPCODE_PTR_BREAK_POINT = (0, 6);
            (int depth, int pc) POST_MSTORE_OPCODE_PTR_BREAK_POINT = MSTORE_OPCODE_PTR_BREAK_POINT with
            {
                pc = MSTORE_OPCODE_PTR_BREAK_POINT.pc + 1
            };

            using DebugTracer tracer = new DebugTracer(GethLikeTxTracer)
            {
                IsStepByStepModeOn = false,
            };

            tracer.SetBreakPoint(MSTORE_OPCODE_PTR_BREAK_POINT);
            tracer.SetBreakPoint(POST_MSTORE_OPCODE_PTR_BREAK_POINT);

            Thread vmThread = new Thread(() => Execute(tracer, bytecode));
            vmThread.Start();

            long? gasAvailable_pre_MSTORE = null;
            while (vmThread.IsAlive)
            {
                if (tracer.CanReadState)
                {
                    // we alter the value stored in memory to force EQ check at the end to fail
                    if (gasAvailable_pre_MSTORE is null) gasAvailable_pre_MSTORE = tracer.CurrentState.GasAvailable;
                    else
                    {
                        long gasAvailable_post_MSTORE = tracer.CurrentState.GasAvailable;
                        Assert.That(gasAvailable_pre_MSTORE - gasAvailable_post_MSTORE, Is.EqualTo(GasCostOf.VeryLow));
                    }
                    tracer.MoveNext();
                }
            }
        }

        [TestCase("ef601700")]
        public void Use_Debug_Tracer_To_Check_failure_status(string bytecodeHex)
        {
            // this bytecode fails on first opcode INVALID
            byte[] bytecode = Bytes.FromHexString(bytecodeHex);

            using DebugTracer tracer = new DebugTracer(GethLikeTxTracer)
            {
                IsStepByStepModeOn = true,
            };

            Thread vmThread = new Thread(() => Execute(tracer, bytecode));
            vmThread.Start();

            while (vmThread.IsAlive)
            {
                if (tracer.CanReadState)
                {
                    tracer.MoveNext();
                }
            }

            // we check if bytecode execution failed
            var resultTraces = (tracer.InnerTracer as GethLikeTxTracer).BuildResult();
            Assert.IsTrue(resultTraces.Failed);
        }


        [TestCase("0x716860176017601701500060005260096017f3600052601260006000f0")]
        public void Debugger_stops_at_correct_breakpoint_depth(string bytecodeHex)
        {
            // this bytecode fails on first opcode INVALID
            byte[] bytecode = Bytes.FromHexString(bytecodeHex);

            (int depth, int pc) TARGET_OPCODE_PTR_BREAK_POINT = (1, 0);
            using DebugTracer tracer = new DebugTracer(GethLikeTxTracer);

            tracer.SetBreakPoint(TARGET_OPCODE_PTR_BREAK_POINT);

            Thread vmThread = new Thread(() => Execute(tracer, bytecode));
            vmThread.Start();

            bool stoppedAtCorrectBreakpoint = false;
            while (vmThread.IsAlive)
            {
                if (tracer.CanReadState)
                {
                    if(tracer.CurrentState.Env.CallDepth == TARGET_OPCODE_PTR_BREAK_POINT.depth && tracer.CurrentState.ProgramCounter == TARGET_OPCODE_PTR_BREAK_POINT.pc)
                    {
                        stoppedAtCorrectBreakpoint = true;
                    } else
                    {
                        stoppedAtCorrectBreakpoint = false;
                    }
                    tracer.MoveNext();
                }
            }

            Assert.That(stoppedAtCorrectBreakpoint, Is.True);
        }

        [TestCase("0x5b601760005600")]
        public void Debugger_Halts_Execution_When_Global_Condition_Is_Met(string bytecodeHex)
        {
            // this bytecode fails on first opcode INVALID
            byte[] bytecode = Bytes.FromHexString(bytecodeHex);

            const int DATA_STACK_HEIGHT = 10;
            using DebugTracer tracer = new DebugTracer(GethLikeTxTracer);

            tracer.SetCondtion(state => state.DataStackHead == DATA_STACK_HEIGHT);

            Thread vmThread = new Thread(() => Execute(tracer, bytecode));
            vmThread.Start();

            bool stoppedAtLeastOneTime = false;
            while (vmThread.IsAlive)
            {
                if (tracer.CanReadState)
                {
                    Assert.That(tracer.CurrentState.DataStackHead, Is.EqualTo(DATA_STACK_HEIGHT));
                    stoppedAtLeastOneTime = true;
                    tracer.MoveNext();
                }
            }

            Assert.That(stoppedAtLeastOneTime, Is.True);
        }

        [TestCase("0x5b601760005600")]
        public void Debugger_Wont_Halt_If_Breakpoint_Is_Unreacheable(string bytecodeHex)
        {
            byte[] bytecode = Bytes.FromHexString(bytecodeHex);

            (int depth, int pc) TARGET_OPCODE_PTR_BREAK_POINT = (1, 0);
            using DebugTracer tracer = new DebugTracer(GethLikeTxTracer);

            tracer.SetBreakPoint(TARGET_OPCODE_PTR_BREAK_POINT);

            Thread vmThread = new Thread(() => Execute(tracer, bytecode));
            vmThread.Start();

            bool stoppedAtCorrectBreakpoint = false;
            while (vmThread.IsAlive)
            {
                if (tracer.CanReadState)
                {
                    stoppedAtCorrectBreakpoint = true;
                    tracer.MoveNext();
                }
            }

            Assert.That(stoppedAtCorrectBreakpoint, Is.False);
        }
    }
}
#endif
